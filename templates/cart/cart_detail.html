{% extends "base.html" %}
{% load static %}

{% block title %}Your Learning Cart{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
{% endblock %}

{% block content %}
<div class="container py-5" style="margin-top: 50px;">
  <h1 class="display-4 mb-4">Your Learning Cart</h1>

  {% if cart|length > 0 %}
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="thead-light">
          <tr>
            <th scope="col" class="pl-4">Course</th>
            <th scope="col">Details</th>
            <th scope="col">Price</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for course in courses %}
          <tr>
            <td class="pl-4 align-middle">
              <div class="d-flex align-items-center">
                <a href="{% url 'course:course-detail' course.slug course.token %}">
                  <img
                    src="{% if course.image %}{{ course.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}"
                    alt="{{ course.title }}" class="img-fluid rounded"
                    style="width: 100px; height: 100px; object-fit: cover;">
                </a>
                <div class="ml-3">
                  <a href="{% url 'course:course-detail' course.slug course.token %}"
                    class="text-primary font-weight-bold">{{course.title }}</a>
                </div>
              </div>
            </td>
            <td class="align-middle">
              <p class="mb-1">{{ course.description|truncatewords:20 }}</p>
              <small class="text-muted">Duration: {{ course.duration|default:"N/A" }}</small><br>
              <small class="text-muted">Level: {{ course.level|default:"Intermediate" }}</small>
            </td>
            <td class="align-middle font-weight-bold">${{ course.price }}</td>
            <td class="align-middle">
              <form action="" method="POST">
                {% csrf_token %}
                <button type="button" name="token" id="remove-item-{{course.token}}" value="{{ course.token }}"
                  style="border: none; background: none; padding: 0; cursor: pointer;">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="bg-light">
            <td colspan="2" class="pl-4 text-right font-weight-bold">Total Courses: {{ cart|length }}</td>
            <td class="font-weight-bold">${{ cart.total_amount }}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-end">
    <a href="{% url 'course:courses-list' %}" class="btn btn-outline-secondary mr-2">Continue Exploring Courses</a>
    <a href="#" class="btn btn-primary">Proceed to Checkout</a>
  </div>
  {% else %}
  <div class="text-center py-5">
    <p class="lead text-muted">Your cart is empty.</p>
    <a href="{% url 'course:courses-list' %}" class="btn btn-primary">Browse Courses</a>
  </div>
  {% endif %}
</div>

<!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<script>

  $(document).ready(function () {
    $('[id^="remove-item-"]').on('click', function (e) {
      e.preventDefault();
      var button = $(this);
      var form = button.closest('form');
      var token = button.val();
      var csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();

      $.ajax({
        type: 'POST',
        url: '{% url "cart:remove-from-cart" %}',
        data: {
          token: token,
          csrfmiddlewaretoken: csrfToken,
          action: 'post'
        },
        dataType: 'json',
        success: function (json) {
          if (json.success) {
            button.closest('tr').remove(); // Remove course row
            $('#total-amount').text(json.total_amount); // Update total
            $('#total-courses').text(json.item_count); // Update item count
            $('#cart-count').text(json.item_count);
            if (json.item_count === 0) {
              $('.card.shadow-sm').replaceWith(
                '<div class="text-center py-5">' +
                '<p class="lead text-muted">Your cart is empty.</p>' +
                '<a href="{% url "course:courses-list" %}" class="btn btn-primary">Browse Courses</a>' +
                '</div>'
              );
            }
          } else {
            alert('Error: ' + json.error);
          }
        },
        error: function (xhr, status, error) {
          console.error('AJAX error:', xhr.status, error);
          alert('Failed to remove course.');
        }
      });
    });
  });
</script>
{% endblock %}